---
- name: Desplegar cambios Django r√°pidamente
  hosts: frontend
  become: yes
  vars_files:
    - "../vars/variables.yml"

  tasks:

    - name: Copiar app core (HTML, templates, management)
      synchronize:
        src: "{{ playbook_dir }}/templates/core/"
        dest: "{{ django_base_dir }}/core/"
        recursive: yes
        delete: no
        rsync_opts:
          - "--exclude=views.py.j2"
          - "--exclude=models.py.j2"
          - "--exclude=forms.py.j2"
          - "--exclude=admin.py.j2"
          - "--exclude=urls.py.j2"

    - name: Renderizar archivos Python de core
      template:
        src: "{{ playbook_dir }}/templates/core/{{ item }}.j2"
        dest: "{{ django_base_dir }}/core/{{ item }}"
        mode: "0644"
      loop:
        - views.py
        - models.py
        - forms.py
        - admin.py
      notify: Restart gunicorn

    - name: Renderizar urls.py de core
      template:
        src: "{{ playbook_dir }}/templates/core/urls.py.j2"
        dest: "{{ django_base_dir }}/core/urls.py"
        mode: "0644"
      notify: Restart gunicorn

    - name: Migraciones
      command: "{{ django_venv }}/bin/python3 manage.py migrate --noinput"
      args:
        chdir: "{{ django_base_dir }}"
      notify: Restart gunicorn

    - name: Staticfiles
      command: "{{ django_venv }}/bin/python3 manage.py collectstatic --noinput"
      args:
        chdir: "{{ django_base_dir }}"
      notify: Restart gunicorn

  handlers:
    - name: Restart gunicorn
      systemd:
        name: gunicorn
        state: restarted
