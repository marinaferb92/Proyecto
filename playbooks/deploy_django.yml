---
- name: Desplegar Django sincronizado con DB existente
  hosts: frontend
  become: yes
  vars_files:
    - ../vars/variables.yml

  tasks:

    ##########################################################
    # 1. CREAR MIGRACIONES DEL CORE
    ##########################################################
    - name: Generar migraciones del core
      command: >
        /var/www/clinica_app/venv/bin/python manage.py makemigrations core
      args:
        chdir: /var/www/clinica_app

    ##########################################################
    # 2. FAKES PARA TODAS LAS APPS QUE YA TIENEN TABLAS
    ##########################################################
    - name: Fake-initial para contenttypes
      command: >
        /var/www/clinica_app/venv/bin/python manage.py migrate contenttypes --fake-initial --noinput
      args:
        chdir: /var/www/clinica_app
      ignore_errors: yes

    - name: Fake-initial para auth
      command: >
        /var/www/clinica_app/venv/bin/python manage.py migrate auth --fake-initial --noinput
      args:
        chdir: /var/www/clinica_app
      ignore_errors: yes

    - name: Fake-initial para admin
      command: >
        /var/www/clinica_app/venv/bin/python manage.py migrate admin --fake-initial --noinput
      args:
        chdir: /var/www/clinica_app
      ignore_errors: yes

    - name: Fake-initial para sessions
      command: >
        /var/www/clinica_app/venv/bin/python manage.py migrate sessions --fake-initial --noinput
      args:
        chdir: /var/www/clinica_app
      ignore_errors: yes

    - name: Fake-initial para core
      command: >
        /var/www/clinica_app/venv/bin/python manage.py migrate core --fake-initial --noinput
      args:
        chdir: /var/www/clinica_app
      ignore_errors: yes

    ##########################################################
    # 3. AHORA SÍ: MIGRACIONES GENERALES (NO CREARÁ DUPLICADOS)
    ##########################################################
    - name: Migraciones globales seguras
      command: >
        /var/www/clinica_app/venv/bin/python manage.py migrate --noinput
      args:
        chdir: /var/www/clinica_app

    ##########################################################
    # 4. RECOLECTAR ESTÁTICOS
    ##########################################################
    - name: Collectstatic
      command: >
        /var/www/clinica_app/venv/bin/python manage.py collectstatic --noinput
      args:
        chdir: /var/www/clinica_app
      ignore_errors: yes

    ##########################################################
    # 5. REINICIAR SERVICIO DJANGO
    ##########################################################
    - name: Reiniciar servicio Django WSGI
      systemd:
        name: django_wsgi
        state: restarted
        enabled: yes

    ##########################################################
    # 6. REINICIAR NGINX
    ##########################################################
    - name: Reiniciar nginx
      systemd:
        name: nginx
        state: restarted
