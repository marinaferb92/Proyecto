---
- name: Desplegar cambios Django rápidamente
  hosts: frontend
  become: yes
  vars_files:
    - "../vars/variables.yml"

  tasks:

    # ------------------------------------------------------
    # 1. Copiar HTML / management / estáticos del core
    # ------------------------------------------------------
    - name: Copiar archivos no-Python del core
      synchronize:
        src: "{{ playbook_dir }}/templates/core/"
        dest: "{{ django_base_dir }}/core/"
        recursive: yes
        delete: no
        rsync_opts:
          - "--exclude=*.py.j2"
          - "--exclude=urls.py.j2"

    # ------------------------------------------------------
    # 2. Renderizar archivos Python del core
    # ------------------------------------------------------
    - name: Renderizar archivos Python de core
      template:
        src: "{{ playbook_dir }}/templates/core/{{ item }}.j2"
        dest: "{{ django_base_dir }}/core/{{ item }}"
        mode: "0644"
      loop:
        - views.py
        - models.py
        - forms.py
        - admin.py
      notify: Restart gunicorn

    # ------------------------------------------------------
    # 3. Renderizar urls.py
    # ------------------------------------------------------
    - name: Renderizar urls.py del core
      template:
        src: "{{ playbook_dir }}/templates/core/urls.py.j2"
        dest: "{{ django_base_dir }}/core/urls.py"
      notify: Restart gunicorn

    # ------------------------------------------------------
    # 4. Migraciones
    # ------------------------------------------------------
    - name: Ejecutar migraciones
      command: "{{ django_venv }}/bin/python3 manage.py migrate --noinput"
      args:
        chdir: "{{ django_base_dir }}"
      notify: Restart gunicorn

    # ------------------------------------------------------
    # 5. Actualizar static
    # ------------------------------------------------------
    - name: Actualizar staticfiles
      command: "{{ django_venv }}/bin/python3 manage.py collectstatic --noinput"
      args:
        chdir: "{{ django_base_dir }}"
      notify: Restart gunicorn

  handlers:
    - name: Restart gunicorn
      systemd:
        name: gunicorn
        state: restarted
