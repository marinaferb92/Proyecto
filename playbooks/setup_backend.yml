---
- name: Instalar y configurar MariaDB (limpio e idempotente)
  hosts: backend
  become: yes
  vars_files:
    - ../vars/variables.yml

  tasks:

    - name: Instalar dependencias Python para mysql
      apt:
        name: python3-pymysql
        state: present
        update_cache: yes

    - name: Instalar MariaDB Server
      apt:
        name: mariadb-server
        state: present
        update_cache: yes

    - name: Asegurar que MariaDB está arrancado
      systemd:
        name: mariadb
        state: started
        enabled: yes

    - name: Establecer contraseña root si nunca se ha puesto
      shell: >
        mysql --user=root --execute="ALTER USER 'root'@'localhost'
        IDENTIFIED BY '{{ db_root_password }}';"
      args:
        executable: /bin/bash
      register: setroot
      failed_when: false
      changed_when: "'ERROR' not in setroot.stderr"

    - name: Crear /root/.my.cnf (para acceso root sin password)
      copy:
        dest: /root/.my.cnf
        mode: "0600"
        content: |
          [client]
          user=root
          password={{ db_root_password }}

    - name: Crear usuario admin de Ansible
      community.mysql.mysql_user:
        name: "{{ db_admin_user }}"
        password: "{{ db_admin_password }}"
        state: present
        host: "%"
        priv: "*.*:ALL"
        login_user: root
        login_password: "{{ db_root_password }}"

    - name: Crear base de datos del proyecto
      community.mysql.mysql_db:
        name: "{{ db_name }}"
        state: present
        login_user: root
        login_password: "{{ db_root_password }}"

    - name: Crear usuario del proyecto
      community.mysql.mysql_user:
        name: "{{ db_user }}"
        password: "{{ db_password }}"
        state: present
        host: "%"
        priv: "{{ db_name }}.*:ALL"
        login_user: root
        login_password: "{{ db_root_password }}"
