---
- name: Instalar y configurar MariaDB en los nodos backend
  hosts: backend
  become: yes

  vars_files:
    - ../vars/variables.yml

  pre_tasks:
    - name: Instalar dependencias
      apt:
        name:
          - python3-pymysql
          - mariadb-server
        state: present
        update_cache: yes

  tasks:

    #-------------------------------------------------------------
    # 1. Asegurar MariaDB
    #-------------------------------------------------------------
    - name: Asegurar que MariaDB est√° arrancado
      systemd:
        name: mariadb
        state: started
        enabled: yes

    #-------------------------------------------------------------
    # 2. Configurar bind-address
    #-------------------------------------------------------------
    - name: Configurar bind-address a 0.0.0.0
      lineinfile:
        path: /etc/mysql/mariadb.conf.d/50-server.cnf
        regexp: '^bind-address'
        line: "bind-address = 0.0.0.0"
      notify: Restart MariaDB

    #-------------------------------------------------------------
    # 3. Crear usuario admin SQL
    #-------------------------------------------------------------
    - name: Crear usuario administrador SQL
      community.mysql.mysql_user:
        name: "{{ db_admin_user }}"
        password: "{{ db_admin_password }}"
        host: "localhost"
        priv: "*.*:ALL,GRANT"
        login_unix_socket: /var/run/mysqld/mysqld.sock
        state: present

    #-------------------------------------------------------------
    # 4. Crear /root/.my.cnf
    #-------------------------------------------------------------
    - name: Crear /root/.my.cnf
      copy:
        dest: /root/.my.cnf
        content: |
          [client]
          user={{ db_admin_user }}
          password={{ db_admin_password }}
        mode: "0600"

    #-------------------------------------------------------------
    # 5. Crear BD (solo si no existe)
    #-------------------------------------------------------------
    - name: Crear base de datos
      community.mysql.mysql_db:
        name: "{{ db_name }}"
        state: present
        encoding: utf8mb4
        collation: utf8mb4_unicode_ci

    #-------------------------------------------------------------
    # 6. Crear usuario frontend
    #-------------------------------------------------------------
    - name: Crear usuario MySQL para frontends
      community.mysql.mysql_user:
        name: "{{ db_user }}"
        password: "{{ db_password }}"
        host: "{{ item }}"
        priv: "{{ db_name }}.*:ALL"
        state: present
      loop:
        - "{{ hostvars['frontend1'].ansible_host }}"
        - "{{ hostvars['frontend2'].ansible_host }}"

  handlers:
    - name: Restart MariaDB
      systemd:
        name: mariadb
        state: restarted
