---
- name: Configurar entorno Django en frontend
  hosts: frontend
  become: yes
  vars_files:
    - "../vars/variables.yml"

  tasks:

    # ------------------------------------------------------
    # 1. Dependencias del sistema
    # ------------------------------------------------------
    - name: Instalar dependencias del sistema
      apt:
        name:
          - python3-dev
          - python3-pip
          - python3-venv
          - default-libmysqlclient-dev
          - build-essential
        state: present
        update_cache: yes

    # ------------------------------------------------------
    # 2. Crear base del proyecto
    # ------------------------------------------------------
    - name: Crear carpeta base del proyecto
      file:
        path: "{{ django_base_dir }}"
        state: directory

    # ------------------------------------------------------
    # 3. Crear entorno virtual
    # ------------------------------------------------------
    - name: Crear entorno virtual
      command: "python3 -m venv {{ django_venv }}"
      args:
        creates: "{{ django_venv }}/bin/activate"

    # ------------------------------------------------------
    # 4. requirements.txt desde plantilla
    # ------------------------------------------------------
    - name: Generar requirements.txt
      template:
        src: "requirements.txt.j2"
        dest: "{{ django_base_dir }}/requirements.txt"

    # ------------------------------------------------------
    # 5. Instalar dependencias pip
    # ------------------------------------------------------
    - name: Instalar paquetes Python
      pip:
        requirements: "{{ django_base_dir }}/requirements.txt"
        virtualenv: "{{ django_venv }}"

    # ------------------------------------------------------
    # 6. Proyecto Django
    # ------------------------------------------------------
    - name: Comprobar si el proyecto Django existe
      stat:
        path: "{{ django_base_dir }}/manage.py"
      register: django_project

    - name: Crear proyecto Django si no existe
      command: "{{ django_venv }}/bin/django-admin startproject {{ django_project_name }} {{ django_base_dir }}"
      when: not django_project.stat.exists

    # ------------------------------------------------------
    # 7. Aplicar plantillas del proyecto
    # ------------------------------------------------------
    - name: Crear settings.py
      template:
        src: "django_settings.py.j2"
        dest: "{{ django_base_dir }}/{{ django_project_name }}/settings.py"

    - name: Crear urls.py
      template:
        src: "django_urls.py.j2"
        dest: "{{ django_base_dir }}/{{ django_project_name }}/urls.py"

    - name: Crear wsgi.py
      template:
        src: "django_wsgi.py.j2"
        dest: "{{ django_base_dir }}/{{ django_project_name }}/wsgi.py"

    # ------------------------------------------------------
    # 8. Instalar la app core (HTML, commands + c√≥digo Python)
    # ------------------------------------------------------

    - name: Crear carpeta core en /var/www/clinica_app/core
      file:
        path: "{{ django_base_dir }}/core"
        state: directory

    - name: Copiar archivos no-Python de core
      synchronize:
        src: "{{ playbook_dir }}/templates/core/"
        dest: "{{ django_base_dir }}/core/"
        recursive: yes
        delete: no
        rsync_opts:
          - "--exclude=*.py.j2"
          - "--exclude=urls.py.j2"

    - name: Renderizar archivos Python del core
      template:
        src: "{{ playbook_dir }}/templates/core/{{ item }}.j2"
        dest: "{{ django_base_dir }}/core/{{ item }}"
      loop:
        - views.py
        - models.py
        - forms.py
        - admin.py

    - name: Renderizar urls.py del core
      template:
        src: "{{ playbook_dir }}/templates/core/urls.py.j2"
        dest: "{{ django_base_dir }}/core/urls.py"

    - name: Asegurar __init__.py
      file:
        path: "{{ django_base_dir }}/core/__init__.py"
        state: touch

    # ------------------------------------------------------
    # 9. Migraciones + static
    # ------------------------------------------------------
    - name: Ejecutar migraciones
      command: "{{ django_venv }}/bin/python3 manage.py migrate --noinput"
      args:
        chdir: "{{ django_base_dir }}"

    - name: Ejecutar collectstatic
      command: "{{ django_venv }}/bin/python3 manage.py collectstatic --noinput"
      args:
        chdir: "{{ django_base_dir }}"

    # ------------------------------------------------------
    # 10. Gunicorn
    # ------------------------------------------------------
    - name: Instalar servicio Gunicorn
      template:
        src: "django_gunicorn.service.j2"
        dest: "/etc/systemd/system/gunicorn.service"

    - name: Recargar systemd
      systemd:
        daemon_reload: yes

    - name: Habilitar y reiniciar Gunicorn
      systemd:
        name: gunicorn
        enabled: yes
        state: restarted
