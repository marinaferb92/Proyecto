---
- name: Configurar entorno Django en los frontends
  hosts: frontend
  become: yes
  vars_files:
    - ../vars/variables.yml

  tasks:

    ##########################################################
    # 1. DEPENDENCIAS
    ##########################################################
    - name: Instalar dependencias
      apt:
        name:
          - python3
          - python3-pip
          - python3-venv
          - build-essential
          - python3-dev
          - default-libmysqlclient-dev
          - pkg-config
          - nginx
        update_cache: yes

    ##########################################################
    # 2. DIRECTORIO DEL PROYECTO
    ##########################################################
    - name: Crear carpeta del proyecto
      file:
        path: /var/www/clinica_app
        state: directory
        mode: "0755"

    ##########################################################
    # 3. VENV
    ##########################################################
    - name: Crear entorno virtual
      command: python3 -m venv /var/www/clinica_app/venv
      args:
        creates: /var/www/clinica_app/venv

    ##########################################################
    # 4. REQUIREMENTS
    ##########################################################
    - name: Copiar requirements.txt
      copy:
        src: ../templates/requirements.txt
        dest: /var/www/clinica_app/requirements.txt

    - name: Instalar paquetes Python
      command: /var/www/clinica_app/venv/bin/pip install -r /var/www/clinica_app/requirements.txt

    ##########################################################
    # 5. CREAR PROYECTO DJANGO
    ##########################################################
    - name: Crear proyecto Django si no existe
      command:
        cmd: /var/www/clinica_app/venv/bin/python -m django startproject clinica .
        chdir: /var/www/clinica_app
      args:
        creates: /var/www/clinica_app/manage.py

    ##########################################################
    # 6. CREAR CORE
    ##########################################################
    - name: Crear app core si no existe
      command:
        cmd: /var/www/clinica_app/venv/bin/python manage.py startapp core
        chdir: /var/www/clinica_app
      args:
        creates: /var/www/clinica_app/core/apps.py

    ##########################################################
    # 7. LIMPIAR Y RECREAR MIGRACIONES
    ##########################################################
    - name: Borrar migraciones antiguas
      file:
        path: /var/www/clinica_app/core/migrations
        state: absent

    - name: Crear carpeta migrations vac√≠a
      file:
        path: /var/www/clinica_app/core/migrations
        state: directory

    - name: Crear __init__.py en migrations
      file:
        path: /var/www/clinica_app/core/migrations/__init__.py
        state: touch

    ##########################################################
    # 8. COPIAR PLANTILLAS (MODELS, VIEWS, URLS, TEMPLATES)
    ##########################################################
    - name: Copiar settings.py
      template:
        src: ../templates/django_settings.py.j2
        dest: /var/www/clinica_app/clinica/settings.py

    - name: Copiar urls.py del proyecto
      template:
        src: ../templates/django_urls.py.j2
        dest: /var/www/clinica_app/clinica/urls.py

    - name: Copiar wsgi.py
      template:
        src: ../templates/django_wsgi.py.j2
        dest: /var/www/clinica_app/clinica/wsgi.py

    - name: Copiar modelos core
      template:
        src: ../templates/core_models.py.j2
        dest: /var/www/clinica_app/core/models.py

    - name: Copiar views core
      template:
        src: ../templates/core_views.py.j2
        dest: /var/www/clinica_app/core/views.py

    - name: Copiar urls core
      template:
        src: ../templates/core_urls.py.j2
        dest: /var/www/clinica_app/core/urls.py

    - name: Copiar forms core
      template:
        src: ../templates/core_forms.py.j2
        dest: /var/www/clinica_app/core/forms.py

    - name: Copiar base.html
      copy:
        src: ../templates/base.html
        dest: /var/www/clinica_app/templates/base.html

    - name: Copiar dashboard
      copy:
        src: ../templates/core_dashboard.html
        dest: /var/www/clinica_app/templates/core_dashboard.html

    - name: Asegurar que la carpeta de templates existe
      file:
        path: /var/www/clinica_app/templates
        state: directory

    ##########################################################
    # 9. COPIAR SERVICIOS SYSTEMD
    ##########################################################
    - name: Copiar servicio WSGI
      template:
        src: ../templates/django_wsgi.service.j2
        dest: /etc/systemd/system/django_wsgi.service
      notify:
        - Reload Systemd

    ##########################################################
    # HANDLERS
    ##########################################################
  handlers:
    - name: Reload Systemd
      systemd:
        daemon_reload: yes
