---
- name: Configurar entorno Django en los frontends
  hosts: frontend
  become: yes
  vars_files:
    - ../vars/variables.yml

  tasks:

    ##########################################################
    # 1. INSTALAR DEPENDENCIAS
    ##########################################################
    - name: Instalar dependencias
      apt:
        name:
          - python3
          - python3-pip
          - python3-venv
          - build-essential
          - python3-dev
          - default-libmysqlclient-dev
          - pkg-config
          - nginx
        update_cache: yes

    ##########################################################
    # 2. DIRECTORIO DEL PROYECTO
    ##########################################################
    - name: Crear carpeta del proyecto
      file:
        path: /var/www/clinica_app
        state: directory
        mode: "0755"

    ##########################################################
    # 3. VENV
    ##########################################################
    - name: Crear venv
      command: python3 -m venv /var/www/clinica_app/venv
      args:
        creates: /var/www/clinica_app/venv

    ##########################################################
    # 4. INSTALAR REQUIREMENTS
    ##########################################################
    - name: Copiar requirements.txt
      copy:
        src: ../templates/requirements.txt
        dest: /var/www/clinica_app/requirements.txt

    - name: Instalar paquetes Python
      command: /var/www/clinica_app/venv/bin/pip install -r /var/www/clinica_app/requirements.txt

    ##########################################################
    # 5. CREAR PROYECTO DJANGO
    ##########################################################
    - name: Crear proyecto Django
      command:
        cmd: /var/www/clinica_app/venv/bin/python -m django startproject clinica .
        chdir: /var/www/clinica_app
      args:
        creates: /var/www/clinica_app/manage.py

    ##########################################################
    # 6. CREAR APP CORE
    ##########################################################
    - name: Crear app core
      command:
        cmd: /var/www/clinica_app/venv/bin/python manage.py startapp core
        chdir: /var/www/clinica_app
      args:
        creates: /var/www/clinica_app/core/apps.py

    ##########################################################
    # 7. LIMPIAR MIGRACIONES CORE (IDEMPOTENCIA REAL)
    ##########################################################
    - name: Borrar carpeta de migraciones antiguas
      file:
        path: /var/www/clinica_app/core/migrations
        state: absent

    - name: Crear carpeta de migraciones nueva
      file:
        path: /var/www/clinica_app/core/migrations
        state: directory

    - name: Crear fichero __init__.py
      file:
        path: /var/www/clinica_app/core/migrations/__init__.py
        state: touch

    ##########################################################
    # 8. COPIAR CONFIGURACIONES, MODELS, VIEWS, URLS
    ##########################################################
    - name: Copiar settings actualizados
      template:
        src: ../templates/django_settings.py.j2
        dest: /var/www/clinica_app/clinica/settings.py

    - name: Copiar urls.py del proyecto
      template:
        src: ../templates/django_urls.py.j2
        dest: /var/www/clinica_app/clinica/urls.py

    - name: Copiar wsgi.py
      template:
        src: ../templates/django_wsgi.py.j2
        dest: /var/www/clinica_app/clinica/wsgi.py
        mode: "0644"

    - name: Copiar apps.py
      template:
        src: ../templates/core_apps.py.j2
        dest: /var/www/clinica_app/core/apps.py

    - name: Copiar models.py
      template:
        src: ../templates/core_models.py.j2
        dest: /var/www/clinica_app/core/models.py

    - name: Copiar views.py
      template:
        src: ../templates/core_views.py.j2
        dest: /var/www/clinica_app/core/views.py

    - name: Copiar forms.py
      template:
        src: ../templates/core_forms.py.j2
        dest: /var/www/clinica_app/core/forms.py

    - name: Copiar urls.py de core
      template:
        src: ../templates/core_urls.py.j2
        dest: /var/www/clinica_app/core/urls.py

    - name: Copiar admin.py
      template:
        src: ../templates/core_admin.py.j2
        dest: /var/www/clinica_app/core/admin.py

    ##########################################################
    # 9. TEMPLATES HTML
    ##########################################################
    - name: Crear carpeta templates/core
      file:
        path: /var/www/clinica_app/templates/core
        state: directory
        recurse: yes

    - name: Copiar base.html
      copy:
        src: ../templates/base.html
        dest: /var/www/clinica_app/templates/base.html

    - name: Copiar dashboard
      copy:
        src: ../templates/core_dashboard.html
        dest: /var/www/clinica_app/templates/core/dashboard.html

    - name: Copiar clientes_list
      copy:
        src: ../templates/core_clientes_list.html
        dest: /var/www/clinica_app/templates/core/clientes_list.html

    - name: Copiar cliente_form
      copy:
        src: ../templates/core_cliente_form.html
        dest: /var/www/clinica_app/templates/core/cliente_form.html

    - name: Copiar citas_list
      copy:
        src: ../templates/core_citas_list.html
        dest: /var/www/clinica_app/templates/core/citas_list.html

    - name: Copiar cita_form
      copy:
        src: ../templates/core_cita_form.html
        dest: /var/www/clinica_app/templates/core/cita_form.html
