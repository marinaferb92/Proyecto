---
- name: Configurar NFS Cliente
  hosts: frontend1,frontend2
  become: yes
  vars_files:
    - ../vars/variables.yml

  tasks:

    - name: Actualizar repositorios
      apt:
        update_cache: yes

    - name: Instalar cliente NFS
      apt:
        name: nfs-common
        state: present

    - name: Crear directorio local si no existe
      file:
        path: "{{ directories.web }}"
        state: directory
        mode: '0755'

    # En vez de 'absent' (que intenta borrar el directorio), usamos 'unmounted'
    - name: Asegurar que no est√° montado previamente (solo desmontar)
      mount:
        path: "{{ directories.web }}"
        state: unmounted
      ignore_errors: yes  # por si no estaba montado, que no falle

    - name: Montar directorio NFS (idempotente)
      mount:
        path: "{{ directories.web }}"
        src: "{{ ip.nfs_server }}:{{ directories.web }}"
        fstype: nfs
        opts: rw,sync,hard,intr
        state: mounted
