---
- name: Clonar BBDD y configurar replicación Maestro → Réplica automáticamente
  hosts: backend
  become: yes
  vars_files:
    - ../vars/variables.yml

  tasks:

############################################################
# 1. Solo backend1: generar dump fresco
############################################################
    - name: Crear dump de la base de datos en backend1
      shell: |
        mysqldump -u root -p"{{ db.root_password }}" --databases {{ db.name }} > /tmp/clinica_db_dump.sql
      when: inventory_hostname == "backend1"

############################################################
# 2. Copiar dump desde backend1 → backend2
############################################################
    - name: Copiar dump desde backend1 a backend2
      fetch:
        src: /tmp/clinica_db_dump.sql
        dest: /tmp/clinica_db_dump.sql
        flat: yes
      when: inventory_hostname == "backend1"

    - name: Subir dump a backend2
      copy:
        src: /tmp/clinica_db_dump.sql
        dest: /tmp/clinica_db_dump.sql
      when: inventory_hostname == "backend2"

############################################################
# 3. Importar dump en backend2
############################################################
    - name: Detener replicación si existía antes
      shell: mysql -u root -p"{{ db.root_password }}" -e "STOP REPLICA;"
      ignore_errors: yes
      when: inventory_hostname == "backend2"

    - name: Resetear replicación en backend2
      shell: mysql -u root -p"{{ db.root_password }}" -e "RESET REPLICA ALL;"
      ignore_errors: yes
      when: inventory_hostname == "backend2"

    - name: Borrar base de datos vieja en backend2
      shell: |
        mysql -u root -p"{{ db.root_password }}" -e "
          DROP DATABASE IF EXISTS {{ db.name }};
          CREATE DATABASE {{ db.name }};
        "
      when: inventory_hostname == "backend2"

    - name: Importar dump en backend2
      shell: |
        mysql -u root -p"{{ db.root_password }}" {{ db.name }} < /tmp/clinica_db_dump.sql
      when: inventory_hostname == "backend2"

############################################################
# 4. Obtener estado del maestro (binlog + pos)
############################################################
    - name: Obtener estado del maestro (SHOW MASTER STATUS)
      shell: |
        mysql -u root -p"{{ db.root_password }}" -e "SHOW MASTER STATUS\G"
      register: master_status_raw
      when: inventory_hostname == "backend1"

    - name: Extraer archivo de binlog
      set_fact:
        binlog_file: "{{ (master_status_raw.stdout | regex_findall('File: (.*)'))[0] }}"
      when: inventory_hostname == "backend1"

    - name: Extraer posición de binlog
      set_fact:
        binlog_pos: "{{ (master_status_raw.stdout | regex_findall('Position: (.*)'))[0] | int }}"
      when: inventory_hostname == "backend1"

############################################################
# 5. Exportar datos de replicación al grupo
############################################################
    - name: Compartir datos de replicación
      add_host:
        name: replication_info
        binlog_file: "{{ binlog_file }}"
        binlog_pos: "{{ binlog_pos }}"
      when: inventory_hostname == "backend1"

############################################################
# 6. Configurar replicación en backend2
############################################################
    - name: Configurar CHANGE REPLICATION SOURCE TO en backend2
      shell: |
        mysql -u root -p"{{ db.root_password }}" -e "
          CHANGE REPLICATION SOURCE TO
            SOURCE_HOST='{{ ip.backend1 }}',
            SOURCE_USER='{{ db.replication_user }}',
            SOURCE_PASSWORD='{{ db.replication_pass }}',
            SOURCE_LOG_FILE='{{ hostvars['replication_info']['binlog_file'] }}',
            SOURCE_LOG_POS={{ hostvars['replication_info']['binlog_pos'] }};
        "
      when: inventory_hostname == "backend2"

    - name: Iniciar replicación
      shell: mysql -u root -p"{{ db.root_password }}" -e "START REPLICA;"
      when: inventory_hostname == "backend2"

############################################################
# 7. Verificar replicación
############################################################
    - name: Comprobar estado de réplica
      shell: mysql -u root -p"{{ db.root_password }}" -e "SHOW REPLICA STATUS\G"
      register: replica_status
      when: inventory_hostname == "backend2"

    - debug:
        var: replica_status.stdout
      when: inventory_hostname == "backend2"
