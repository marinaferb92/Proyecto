---
- name: Activar HTTPS con Let's Encrypt
  hosts: lb
  become: yes
  vars_files:
    - ../vars/variables.yml

  tasks:

    - name: Instalar Certbot + plugin de nginx
      apt:
        name:
          - certbot
          - python3-certbot-nginx
        state: present
        update_cache: true

    - name: Generar certificado SSL automÃ¡ticamente
      command:
        cmd: >
          certbot --nginx
          -d {{ domain_name }}
          --agree-tos
          --email {{ certbot_email }}
          --redirect
          --non-interactive
      register: certbot_output
      failed_when: certbot_output.rc not in [0, 1]
      changed_when: certbot_output.rc == 0

    - name: Mostrar salida de certbot
      debug:
        msg: "{{ certbot_output.stdout }}"
