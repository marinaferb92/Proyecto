---
- name: Configuración completa del módulo de análisis de datos
  hosts: backend1
  become: yes

  vars:
    analisis_dir: /home/ubuntu/clinica_project/analisis
    python_packages:
      - pandas
      - numpy
      - matplotlib
      - mysql-connector-python
      - scikit-learn
      - seaborn

  tasks:

    # ===========================================
    # 1. Instalar pip y dependencias del sistema
    # ===========================================
    - name: Instalar pip
      apt:
        name: python3-pip
        state: present
        update_cache: yes

    - name: Instalar librerías Python necesarias
      pip:
        name: "{{ python_packages }}"
        state: present
        executable: pip3

    # ===========================================
    # 2. Crear carpeta output para los resultados
    # ===========================================
    - name: Crear carpeta output para analíticas
      ansible.builtin.file:
        path: "{{ analisis_dir }}/output"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    # ===========================================
    # 3. Configurar cron para ejecutar análisis diarios
    # ===========================================
    - name: Crear cronjob para análisis RFM
      cron:
        name: "analisis_rfm"
        user: ubuntu
        job: "/usr/bin/python3 {{ analisis_dir }}/analisis_rfm.py"
        minute: "0"
        hour: "3"

    - name: Crear cronjob para análisis de stock
      cron:
        name: "analisis_stock"
        user: ubuntu
        job: "/usr/bin/python3 {{ analisis_dir }}/stock_analisis.py"
        minute: "5"
        hour: "3"

    - name: Crear cronjob para análisis productividad empleados
      cron:
        name: "analisis_productividad"
        user: ubuntu
        job: "/usr/bin/python3 {{ analisis_dir }}/productividad_empleados.py"
        minute: "10"
        hour: "3"

    - name: Mensaje final
      debug:
        msg: "Módulo de análisis instalado correctamente. Cronjobs programados."
