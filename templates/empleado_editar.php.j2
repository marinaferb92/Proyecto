<?php
require_once 'config.php';
require_once 'auth.php';

require_login();
require_role(['admin']);

$id = $_GET['id'] ?? null;

$empleado = [
  'nombre' => '',
  'apellido' => '',
  'telefono' => '',
  'email' => '',
  'categoria_id' => null,
  'activo' => 1
];

if ($id) {
    $stmt = $pdo->prepare("SELECT * FROM Empleados WHERE empleado_id = ?");
    $stmt->execute([$id]);
    $empleado = $stmt->fetch();

    if (!$empleado) die("Empleado no encontrado");
}

$cats = $pdo->query("SELECT categoria_id, nombre FROM CategoriasEmpleados ORDER BY nombre")->fetchAll();

if ($_SERVER["REQUEST_METHOD"] === "POST") {

    $data = [
        $_POST['nombre'],
        $_POST['apellido'],
        $_POST['telefono'],
        $_POST['email'],
        $_POST['categoria_id'] ?: null,
        isset($_POST['activo']) ? 1 : 0
    ];

    if ($id) {
        $data[] = $id;
        $sql = "UPDATE Empleados SET nombre=?, apellido=?, telefono=?, email=?, categoria_id=?, activo=? WHERE empleado_id=?";
        $pdo->prepare($sql)->execute($data);
    } else {
        $sql = "INSERT INTO Empleados (nombre, apellido, telefono, email, categoria_id, activo)
                VALUES (?, ?, ?, ?, ?, ?)";
        $pdo->prepare($sql)->execute($data);
    }

    header("Location: empleados.php");
    exit;
}

$pageTitle = $id ? "Editar Empleado" : "Nuevo Empleado";
include 'header.php';
?>

<h3 class="mb-4"><i class="bi bi-person-badge me-2"></i><?= $pageTitle ?></h3>

<form method="POST" class="card card-body shadow-sm">

  <div class="row mb-3">
    <div class="col-md-6">
      <label class="form-label">Nombre</label>
      <input name="nombre" class="form-control" required value="<?= htmlspecialchars($empleado['nombre']) ?>">
    </div>
    <div class="col-md-6">
      <label class="form-label">Apellido</label>
      <input name="apellido" class="form-control" required value="<?= htmlspecialchars($empleado['apellido']) ?>">
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-4">
      <label class="form-label">Teléfono</label>
      <input name="telefono" class="form-control" value="<?= htmlspecialchars($empleado['telefono']) ?>">
    </div>
    <div class="col-md-4">
      <label class="form-label">Email</label>
      <input name="email" class="form-control" value="<?= htmlspecialchars($empleado['email']) ?>">
    </div>

    <div class="col-md-4">
      <label class="form-label">Categoría</label>
      <select name="categoria_id" class="form-select">
        <option value="">Sin categoría</option>
        <?php foreach ($cats as $c): ?>
          <option value="<?= $c['categoria_id'] ?>" <?= $empleado['categoria_id']==$c['categoria_id']?'selected':'' ?>>
            <?= htmlspecialchars($c['nombre']) ?>
          </option>
        <?php endforeach; ?>
      </select>
    </div>
  </div>

  <label class="form-check mb-3">
    <input type="checkbox" name="activo" class="form-check-input" <?= $empleado['activo'] ? "checked" : "" ?>>
    <span class="form-check-label">Activo</span>
  </label>

  <div class="text-end">
    <a href="empleados.php" class="btn btn-outline-secondary">Cancelar</a>
    <button class="btn btn-primary">Guardar</button>
  </div>

</form>

<?php include 'footer.php'; ?>
