from django.db import models

###################################################################
# CLIENTES
###################################################################

class Clientes(models.Model):
    cliente_id = models.AutoField(primary_key=True)
    dni = models.CharField(max_length=15, unique=True, null=True, blank=True)
    nombre = models.CharField(max_length=100)
    apellido = models.CharField(max_length=100)
    fecha_nacimiento = models.DateField(null=True, blank=True)
    edad = models.IntegerField(null=True, blank=True)
    genero = models.CharField(
        max_length=20,
        choices=[('Hombre', 'Hombre'), ('Mujer', 'Mujer'), ('Otro', 'Otro')],
        default='Mujer'
    )
    telefono = models.CharField(max_length=20, null=True, blank=True)
    correo = models.CharField(max_length=100, null=True, blank=True)
    direccion = models.TextField(null=True, blank=True)
    fecha_registro = models.DateField(null=True, blank=True)
    origen_cliente = models.CharField(
        max_length=20,
        choices=[
            ('Google','Google'),
            ('Instagram','Instagram'),
            ('Recomendacion','Recomendacion'),
            ('Web','Web'),
            ('Publicidad','Publicidad'),
            ('Otro','Otro')
        ],
        default='Recomendacion'
    )

    class Meta:
        db_table = "Clientes"
        ordering = ("cliente_id",)

    def __str__(self):
        return f"{self.nombre} {self.apellido}"


###################################################################
# CATEGORÍAS EMPLEADOS
###################################################################

class CategoriasEmpleados(models.Model):
    categoria_id = models.AutoField(primary_key=True)
    nombre = models.CharField(max_length=50)
    descripcion = models.TextField(null=True, blank=True)

    class Meta:
        db_table = "CategoriasEmpleados"
        ordering = ("categoria_id",)

    def __str__(self):
        return self.nombre


###################################################################
# EMPLEADOS
###################################################################

class Empleados(models.Model):
    empleado_id = models.AutoField(primary_key=True)
    nombre = models.CharField(max_length=100)
    apellido = models.CharField(max_length=100)
    fecha_ingreso = models.DateField(null=True, blank=True)
    telefono = models.CharField(max_length=20, null=True, blank=True)
    email = models.CharField(max_length=100, null=True, blank=True)
    categoria = models.ForeignKey(CategoriasEmpleados, on_delete=models.SET_NULL, null=True)
    activo = models.BooleanField(default=True)

    class Meta:
        db_table = "Empleados"
        ordering = ("empleado_id",)

    def __str__(self):
        return f"{self.nombre} {self.apellido}"


###################################################################
# ESPECIALIDADES Y RELACIÓN M:M
###################################################################

class Especialidades(models.Model):
    especialidad_id = models.AutoField(primary_key=True)
    nombre = models.CharField(max_length=100)
    descripcion = models.TextField(null=True, blank=True)

    class Meta:
        db_table = "Especialidades"

    def __str__(self):
        return self.nombre


class EmpleadoEspecialidad(models.Model):
    empleado = models.ForeignKey(Empleados, on_delete=models.CASCADE)
    especialidad = models.ForeignKey(Especialidades, on_delete=models.CASCADE)

    class Meta:
        db_table = "EmpleadoEspecialidad"
        unique_together = ("empleado", "especialidad")


###################################################################
# FICHAS MÉDICAS
###################################################################

class FichasMedicas(models.Model):
    ficha_id = models.AutoField(primary_key=True)
    cliente = models.ForeignKey(Clientes, on_delete=models.CASCADE)
    alergias = models.TextField(null=True, blank=True)
    antecedentes = models.TextField(null=True, blank=True)
    observaciones = models.TextField(null=True, blank=True)
    fecha_actualizacion = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = "FichasMedicas"

    def __str__(self):
        return f"Ficha médica de {self.cliente}"


###################################################################
# SALAS
###################################################################

class Salas(models.Model):
    sala_id = models.AutoField(primary_key=True)
    nombre = models.CharField(max_length=100)
    tipo = models.CharField(
        max_length=20,
        choices=[
            ('Tratamiento','Tratamiento'),
            ('Consulta','Consulta'),
            ('Láser','Láser'),
            ('Cabina','Cabina'),
            ('Quirófano','Quirófano')
        ],
        default='Tratamiento'
    )
    capacidad = models.IntegerField(default=1)

    class Meta:
        db_table = "Salas"

    def __str__(self):
        return self.nombre


###################################################################
# CATEGORÍAS TRATAMIENTOS
###################################################################

class CategoriasTratamientos(models.Model):
    categoria_id = models.AutoField(primary_key=True)
    nombre = models.CharField(max_length=100)
    descripcion = models.TextField(null=True, blank=True)

    class Meta:
        db_table = "CategoriasTratamientos"

    def __str__(self):
        return self.nombre


###################################################################
# TRATAMIENTOS
###################################################################

class Tratamientos(models.Model):
    tratamiento_id = models.AutoField(primary_key=True)
    nombre = models.CharField(max_length=100)
    descripcion = models.TextField(null=True, blank=True)
    precio = models.DecimalField(max_digits=10, decimal_places=2)
    duracion_min = models.IntegerField()
    categoria = models.ForeignKey(CategoriasTratamientos, on_delete=models.SET_NULL, null=True)
    requiere_sala = models.BooleanField(default=True)

    class Meta:
        db_table = "Tratamientos"

    def __str__(self):
        return self.nombre


###################################################################
# TRATAMIENTOS PREVIOS
###################################################################

class TratamientosPrevios(models.Model):
    cliente = models.ForeignKey(Clientes, on_delete=models.CASCADE)
    tratamiento = models.ForeignKey(Tratamientos, on_delete=models.CASCADE)
    fecha_tratamiento = models.DateField()
    notas = models.TextField(null=True, blank=True)

    class Meta:
        db_table = "TratamientosPrevios"
        unique_together = ("cliente", "tratamiento", "fecha_tratamiento")


###################################################################
# CITAS
###################################################################

class Citas(models.Model):
    cita_id = models.AutoField(primary_key=True)
    cliente = models.ForeignKey(Clientes, on_delete=models.CASCADE)
    empleado = models.ForeignKey(Empleados, on_delete=models.CASCADE)
    tratamiento = models.ForeignKey(Tratamientos, on_delete=models.CASCADE)
    sala = models.ForeignKey(Salas, on_delete=models.SET_NULL, null=True)
    fecha_cita = models.DateField()
    hora_cita = models.TimeField()
    estado = models.CharField(
        max_length=20,
        choices=[
            ('pendiente','pendiente'),
            ('confirmada','confirmada'),
            ('realizada','realizada'),
            ('cancelada','cancelada'),
            ('reprogramada','reprogramada')
        ],
        default='pendiente'
    )
    observaciones = models.TextField(null=True, blank=True)

    class Meta:
        db_table = "Citas"

    def __str__(self):
        return f"Cita {self.cita_id}"


###################################################################
# PAGOS
###################################################################

class Pagos(models.Model):
    pago_id = models.AutoField(primary_key=True)
    cita = models.ForeignKey(Citas, on_delete=models.CASCADE)
    metodo_pago = models.CharField(
        max_length=20,
        choices=[
            ('efectivo','efectivo'),
            ('tarjeta','tarjeta'),
            ('transferencia','transferencia'),
            ('bizum','bizum'),
            ('otro','otro')
        ],
        default='tarjeta'
    )
    monto = models.DecimalField(max_digits=10, decimal_places=2)
    fecha_pago = models.DateTimeField(auto_now_add=True)

    class Meta:
        db_table = "Pagos"


###################################################################
# VALORACIONES
###################################################################

class Valoraciones(models.Model):
    valoracion_id = models.AutoField(primary_key=True)
    cita = models.ForeignKey(Citas, on_delete=models.CASCADE)
    puntuacion = models.IntegerField()
    comentario = models.TextField(null=True, blank=True)
    fecha_valoracion = models.DateTimeField(auto_now_add=True)

    class Meta:
        db_table = "Valoraciones"


###################################################################
# PROVEEDORES
###################################################################

class Proveedores(models.Model):
    proveedor_id = models.AutoField(primary_key=True)
    nombre = models.CharField(max_length=100)
    telefono = models.CharField(max_length=20, null=True, blank=True)
    correo = models.CharField(max_length=100, null=True, blank=True)
    direccion = models.TextField(null=True, blank=True)

    class Meta:
        db_table = "Proveedores"

    def __str__(self):
        return self.nombre


###################################################################
# INVENTARIO
###################################################################

class Inventario(models.Model):
    item_id = models.AutoField(primary_key=True)
    nombre = models.CharField(max_length=100)
    tipo = models.CharField(
        max_length=20,
        choices=[('insumo','insumo'), ('producto','producto'), ('equipamiento','equipamiento')],
        default='insumo'
    )
    stock_actual = models.IntegerField(default=0)
    unidad = models.CharField(max_length=20, null=True, blank=True)
    costo_unitario = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True)
    proveedor = models.ForeignKey(Proveedores, on_delete=models.SET_NULL, null=True)

    class Meta:
        db_table = "Inventario"

    def __str__(self):
        return self.nombre


###################################################################
# CONSUMO MATERIAL
###################################################################

class ConsumoMaterial(models.Model):
    cita = models.ForeignKey(Citas, on_delete=models.CASCADE)
    item = models.ForeignKey(Inventario, on_delete=models.CASCADE)
    cantidad_usada = models.IntegerField()

    class Meta:
        db_table = "ConsumoMaterial"
        unique_together = ("cita", "item")


###################################################################
# MOVIMIENTOS INVENTARIO
###################################################################

class MovimientosInventario(models.Model):
    movimiento_id = models.AutoField(primary_key=True)
    item = models.ForeignKey(Inventario, on_delete=models.CASCADE)
    tipo = models.CharField(
        max_length=20,
        choices=[('entrada','entrada'), ('salida','salida'), ('ajuste','ajuste')]
    )
    cantidad = models.IntegerField()
    fecha_movimiento = models.DateTimeField(auto_now_add=True)
    descripcion = models.TextField(null=True, blank=True)

    class Meta:
        db_table = "MovimientosInventario"


###################################################################
# CAMPAÑAS MARKETING
###################################################################

class CampañasMarketing(models.Model):
    campaña_id = models.AutoField(primary_key=True)
    nombre = models.CharField(max_length=100)
    canal = models.CharField(
        max_length=20,
        choices=[
            ('Instagram','Instagram'),
            ('Facebook','Facebook'),
            ('Google Ads','Google Ads'),
            ('Cartelería','Cartelería'),
            ('Colaboración','Colaboración'),
            ('Otro','Otro')
        ],
        default='Instagram'
    )
    fecha_inicio = models.DateField(null=True, blank=True)
    fecha_fin = models.DateField(null=True, blank=True)
    presupuesto = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True)

    class Meta:
        db_table = "CampañasMarketing"

    def __str__(self):
        return self.nombre


###################################################################
# PROMOCIONES
###################################################################

class DescuentosPromociones(models.Model):
    promo_id = models.AutoField(primary_key=True)
    nombre = models.CharField(max_length=100)
    tipo = models.CharField(
        max_length=20,
        choices=[('porcentaje','porcentaje'), ('cantidad_fija','cantidad_fija')]
    )
    valor = models.DecimalField(max_digits=10, decimal_places=2)
    fecha_inicio = models.DateField(null=True, blank=True)
    fecha_fin = models.DateField(null=True, blank=True)

    class Meta:
        db_table = "DescuentosPromociones"

    def __str__(self):
        return self.nombre


class CitaPromocion(models.Model):
    cita = models.ForeignKey(Citas, on_delete=models.CASCADE)
    promo = models.ForeignKey(DescuentosPromociones, on_delete=models.CASCADE)

    class Meta:
        db_table = "CitaPromocion"
        unique_together = ("cita", "promo")


###################################################################
# LOGS
###################################################################

class LogsActividad(models.Model):
    log_id = models.AutoField(primary_key=True)
    empleado = models.ForeignKey(Empleados, on_delete=models.SET_NULL, null=True)
    accion = models.CharField(max_length=255)
    fecha = models.DateTimeField(auto_now_add=True)

    class Meta:
        db_table = "LogsActividad"


###################################################################
# ESTADISTICAS
###################################################################

class EstadisticasDiarias(models.Model):
    fecha = models.DateField(primary_key=True)
    citas_totales = models.IntegerField(null=True, blank=True)
    citas_realizadas = models.IntegerField(null=True, blank=True)
    citas_canceladas = models.IntegerField(null=True, blank=True)
    ingresos_totales = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True)
    tratamientos_distintos = models.IntegerField(null=True, blank=True)

    class Meta:
        db_table = "EstadisticasDiarias"

    def __str__(self):
        return str(self.fecha)
