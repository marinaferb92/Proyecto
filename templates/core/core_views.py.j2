from django.shortcuts import render, get_object_or_404, redirect
from django.contrib.auth.decorators import login_required
from django.forms import ModelForm
from django.contrib import messages
from django.utils import timezone

from .models import Patient, Doctor, Appointment, StockItem


class PatientForm(ModelForm):
    class Meta:
        model = Patient
        fields = ["first_name", "last_name", "dni", "phone", "email"]


class AppointmentForm(ModelForm):
    class Meta:
        model = Appointment
        fields = ["patient", "doctor", "date", "time", "reason", "status"]


class StockForm(ModelForm):
    class Meta:
        model = StockItem
        fields = ["name", "sku", "quantity", "min_quantity"]


@login_required
def dashboard(request):
    today = timezone.localdate()
    upcoming_appointments = Appointment.objects.filter(date__gte=today).order_by("date", "time")[:10]
    low_stock = StockItem.objects.all()
    low_stock = [item for item in low_stock if item.is_below_min]

    context = {
        "upcoming_appointments": upcoming_appointments,
        "low_stock": low_stock,
    }
    return render(request, "core/dashboard.html", context)


@login_required
def appointment_list(request):
    appointments = Appointment.objects.select_related("patient", "doctor").order_by("date", "time")
    return render(request, "core/appointment_list.html", {"appointments": appointments})


@login_required
def appointment_create(request):
    if request.method == "POST":
        form = AppointmentForm(request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, "Cita creada correctamente.")
            return redirect("core:appointment_list")
    else:
        form = AppointmentForm()
    return render(request, "core/appointment_form.html", {"form": form})


@login_required
def appointment_update(request, pk):
    appointment = get_object_or_404(Appointment, pk=pk)
    if request.method == "POST":
        form = AppointmentForm(request.POST, instance=appointment)
        if form.is_valid():
            form.save()
            messages.success(request, "Cita actualizada correctamente.")
            return redirect("core:appointment_list")
    else:
        form = AppointmentForm(instance=appointment)
    return render(request, "core/appointment_form.html", {"form": form})


@login_required
def appointment_delete(request, pk):
    appointment = get_object_or_404(Appointment, pk=pk)
    if request.method == "POST":
        appointment.delete()
        messages.success(request, "Cita eliminada.")
        return redirect("core:appointment_list")
    return render(request, "core/appointment_confirm_delete.html", {"appointment": appointment})


@login_required
def patient_list(request):
    patients = Patient.objects.order_by("last_name", "first_name")
    return render(request, "core/patient_list.html", {"patients": patients})


@login_required
def patient_create(request):
    if request.method == "POST":
        form = PatientForm(request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, "Paciente creado.")
            return redirect("core:patient_list")
    else:
        form = PatientForm()
    return render(request, "core/patient_form.html", {"form": form})


@login_required
def patient_update(request, pk):
    patient = get_object_or_404(Patient, pk=pk)
    if request.method == "POST":
        form = PatientForm(request.POST, instance=patient)
        if form.is_valid():
            form.save()
            messages.success(request, "Paciente actualizado.")
            return redirect("core:patient_list")
    else:
        form = PatientForm(instance=patient)
    return render(request, "core/patient_form.html", {"form": form})


@login_required
def stock_list(request):
    items = StockItem.objects.order_by("name")
    return render(request, "core/stock_list.html", {"items": items})


@login_required
def stock_create(request):
    if request.method == "POST":
        form = StockForm(request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, "Producto de stock creado.")
            return redirect("core:stock_list")
    else:
        form = StockForm()
    return render(request, "core/stock_form.html", {"form": form})


@login_required
def stock_update(request, pk):
    item = get_object_or_404(StockItem, pk=pk)
    if request.method == "POST":
        form = StockForm(request.POST, instance=item)
        if form.is_valid():
            form.save()
            messages.success(request, "Stock actualizado.")
            return redirect("core:stock_list")
    else:
        form = StockForm(instance=item)
    return render(request, "core/stock_form.html", {"form": form})
