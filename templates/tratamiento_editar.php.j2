<?php
require_once 'config.php';
require_once 'auth.php';

require_login();
require_role(['admin']);

$id = $_GET['id'] ?? null;

$trat = [
  'nombre' => '',
  'descripcion' => '',
  'precio' => '',
  'duracion_min' => '',
  'categoria_id' => null,
  'requiere_sala' => 1
];

if ($id) {
    $stmt = $pdo->prepare("SELECT * FROM Tratamientos WHERE tratamiento_id = ?");
    $stmt->execute([$id]);
    $trat = $stmt->fetch();

    if (!$trat) die("Tratamiento no encontrado");
}

$cats = $pdo->query("SELECT categoria_id, nombre FROM CategoriasTratamientos ORDER BY nombre")->fetchAll();

if ($_SERVER["REQUEST_METHOD"] === "POST") {

    $data = [
        $_POST['nombre'],
        $_POST['descripcion'],
        $_POST['precio'],
        $_POST['duracion_min'],
        $_POST['categoria_id'] ?: null,
        isset($_POST['requiere_sala']) ? 1 : 0
    ];

    if ($id) {
        $data[] = $id;
        $sql = "UPDATE Tratamientos
                SET nombre=?, descripcion=?, precio=?, duracion_min=?, categoria_id=?, requiere_sala=?
                WHERE tratamiento_id=?";
        $pdo->prepare($sql)->execute($data);
    } else {
        $sql = "INSERT INTO Tratamientos 
                (nombre, descripcion, precio, duracion_min, categoria_id, requiere_sala)
                VALUES (?, ?, ?, ?, ?, ?)";
        $pdo->prepare($sql)->execute($data);
    }

    header("Location: tratamientos.php");
    exit;
}

$pageTitle = $id ? "Editar Tratamiento" : "Nuevo Tratamiento";
include 'header.php';
?>

<h3 class="mb-4"><i class="bi bi-heart me-2"></i><?= $pageTitle ?></h3>

<form method="POST" class="card card-body shadow-sm">

  <div class="mb-3">
    <label class="form-label">Nombre</label>
    <input name="nombre" class="form-control" required value="<?= htmlspecialchars($trat['nombre']) ?>">
  </div>

  <div class="mb-3">
    <label class="form-label">Descripción</label>
    <textarea name="descripcion" class="form-control" rows="4"><?= htmlspecialchars($trat['descripcion']) ?></textarea>
  </div>

  <div class="row mb-3">
    <div class="col-md-4">
      <label class="form-label">Precio (€)</label>
      <input name="precio" type="number" step="0.01" class="form-control"
             value="<?= htmlspecialchars($trat['precio']) ?>" required>
    </div>

    <div class="col-md-4">
      <label class="form-label">Duración (min)</label>
      <input name="duracion_min" type="number" class="form-control"
             value="<?= htmlspecialchars($trat['duracion_min']) ?>" required>
    </div>

    <div class="col-md-4">
      <label class="form-label">Categoría</label>
      <select name="categoria_id" class="form-select">
        <option value="">Sin categoría</option>
        <?php foreach ($cats as $c): ?>
          <option value="<?= $c['categoria_id'] ?>" <?= $trat['categoria_id']==$c['categoria_id']??''?'selected':'' ?>>
            <?= htmlspecialchars($c['nombre']) ?>
          </option>
        <?php endforeach; ?>
      </select>
    </div>
  </div>

  <label class="form-check mb-3">
    <input type="checkbox" name="requiere_sala" class="form-check-input" <?= $trat['requiere_sala'] ? "checked" : "" ?>>
    <span class="form-check-label">Requiere sala</span>
  </label>

  <div class="text-end">
    <a href="tratamientos.php" class="btn btn-outline-secondary">Cancelar</a>
    <button class="btn btn-primary">Guardar</button>
  </div>

</form>

<?php include 'footer.php'; ?>
