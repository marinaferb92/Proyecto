<?php
require_once 'config.php';
require_once 'auth.php';

require_login();
require_role(['admin','recepcionista']);

$pageTitle = "Promociones y descuentos";
include 'header.php';

$hoy = date("Y-m-d");
$estado = $_GET['estado'] ?? '';

$sql = "SELECT *, 
        IF(CURDATE() BETWEEN fecha_inicio AND fecha_fin, 1, 0) AS activa
        FROM DescuentosPromociones
        WHERE 1=1";

if ($estado === "activas") {
    $sql .= " AND CURDATE() BETWEEN fecha_inicio AND fecha_fin";
}
if ($estado === "caducadas") {
    $sql .= " AND CURDATE() > fecha_fin";
}
if ($estado === "futuras") {
    $sql .= " AND CURDATE() < fecha_inicio";
}

$sql .= " ORDER BY fecha_inicio DESC";

$promos = $pdo->query($sql)->fetchAll();
?>

<div class="d-flex justify-content-between mb-3">
    <h3><i class="bi bi-percent"></i> Promociones</h3>
    <a href="promocion_editar.php" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Nueva promoción
    </a>
</div>

<form class="card card-body shadow-sm mb-3">
    <div class="row g-2">
        <div class="col-md-3">
            <select name="estado" class="form-select" onchange="this.form.submit()">
                <option value="">Todas</option>
                <option value="activas" <?= $estado=="activas"?"selected":"" ?>>Activas</option>
                <option value="futuras" <?= $estado=="futuras"?"selected":"" ?>>Futuras</option>
                <option value="caducadas" <?= $estado=="caducadas"?"selected":"" ?>>Caducadas</option>
            </select>
        </div>
    </div>
</form>

<div class="card shadow-sm">
<table class="table table-hover mb-0">
<thead class="table-light">
<tr>
    <th>Nombre</th>
    <th>Tipo</th>
    <th>Valor</th>
    <th>Desde</th>
    <th>Hasta</th>
    <th>Estado</th>
    <th class="text-end">Acciones</th>
</tr>
</thead>
<tbody>

<?php foreach($promos as $p): ?>
<tr class="<?= $p['activa'] ? 'table-success' : '' ?>">
    <td><?= htmlspecialchars($p['nombre']) ?></td>
    <td><?= $p['tipo']=="porcentaje"?"%":"€" ?></td>
    <td><?= $p['valor'] ?></td>
    <td><?= $p['fecha_inicio'] ?></td>
    <td><?= $p['fecha_fin'] ?></td>
    <td>
        <?php if ($p['activa']): ?>
            <span class="badge bg-success">Activa</span>
        <?php else: ?>
            <span class="badge bg-secondary">Inactiva</span>
        <?php endif; ?>
    </td>
    <td class="text-end">
        <a href="promocion_editar.php?id=<?= $p['promo_id'] ?>" 
           class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></a>

        <a href="promocion_borrar.php?id=<?= $p['promo_id'] ?>"
           onclick="return confirm('¿Borrar promoción?')"
           class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></a>
    </td>
</tr>
<?php endforeach; ?>

</tbody>
</table>
</div>

<?php include 'footer.php'; ?>
