<?php
require_once 'config.php';
require_once 'auth.php';

require_login();
require_role(['admin','recepcionista']);

$pageTitle = "Empleados";
include 'header.php';

$q = trim($_GET['q'] ?? '');

$sql = "
    SELECT e.*, c.nombre AS categoria
    FROM Empleados e
    LEFT JOIN CategoriasEmpleados c ON c.categoria_id = e.categoria_id
    WHERE 1=1
";

$params = [];

if ($q !== '') {
    $sql .= " AND (
        e.nombre LIKE :q OR 
        e.apellido LIKE :q OR 
        e.email LIKE :q
    )";
    $params[':q'] = "%$q%";
}

$sql .= " ORDER BY e.nombre ASC";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$empleados = $stmt->fetchAll();
?>

<div class="d-flex justify-content-between mb-4">
  <h3><i class="bi bi-people me-2"></i>Empleados</h3>
  <a href="empleado_editar.php" class="btn btn-primary">
      <i class="bi bi-plus-circle"></i> Nuevo empleado
  </a>
</div>

<form class="card card-body shadow-sm mb-4" method="get">
  <div class="row g-3">
    <div class="col-md-6">
      <input name="q"
             value="<?= htmlspecialchars($q) ?>"
             class="form-control"
             placeholder="Buscar por nombre, apellido o email">
    </div>
    <div class="col-md-2">
      <button class="btn btn-outline-primary w-100"><i class="bi bi-search"></i> Buscar</button>
    </div>
  </div>
</form>

<div class="card shadow-sm">
  <table class="table table-hover mb-0">
    <thead class="table-light">
      <tr>
        <th>Nombre</th>
        <th>Teléfono</th>
        <th>Email</th>
        <th>Categoría</th>
        <th>Activo</th>
        <th class="text-end">Acciones</th>
      </tr>
    </thead>

    <tbody>
    <?php if ($empleados): ?>
      <?php foreach ($empleados as $e): ?>
        <tr>
          <td><?= htmlspecialchars($e['nombre'].' '.$e['apellido']) ?></td>
          <td><?= htmlspecialchars($e['telefono']) ?></td>
          <td><?= htmlspecialchars($e['email']) ?></td>
          <td><?= htmlspecialchars($e['categoria']) ?></td>
          <td><?= $e['activo'] ? "Sí" : "No" ?></td>
          <td class="text-end">
            <a class="btn btn-sm btn-outline-primary" href="empleado_editar.php?id=<?= $e['empleado_id'] ?>">
              <i class="bi bi-pencil"></i>
            </a>
            <a class="btn btn-sm btn-outline-danger"
               href="empleado_borrar.php?id=<?= $e['empleado_id'] ?>"
               onclick="return confirm('¿Eliminar empleado?')">
               <i class="bi bi-trash"></i>
            </a>
          </td>
        </tr>
      <?php endforeach; ?>
    <?php else: ?>
        <tr><td colspan="6" class="text-center py-4 text-muted">No hay empleados</td></tr>
    <?php endif; ?>
    </tbody>

  </table>
</div>

<?php include 'footer.php'; ?>
