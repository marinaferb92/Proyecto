<?php
// categoria_tratamiento_editar.php
require_once 'config.php';
require_once 'auth.php';

require_login();
require_role(['admin']);

$id = isset($_GET['id']) ? (int)$_GET['id'] : 0;
$esEdicion = $id > 0;

$pageTitle = $esEdicion ? "Editar categoría de tratamiento" : "Nueva categoría de tratamiento";
include 'header.php';

$categoria = [
    'nombre' => '',
    'descripcion' => ''
];

if ($esEdicion) {
    $stmt = $pdo->prepare("SELECT * FROM CategoriasTratamientos WHERE categoria_id = :id");
    $stmt->execute([':id' => $id]);
    $data = $stmt->fetch();
    if (!$data) {
        echo "<div class='alert alert-danger mt-3'>Categoría no encontrada.</div>";
        include 'footer.php';
        exit;
    }
    $categoria = $data;
}

$errores = [];
$ok = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $categoria['nombre'] = trim($_POST['nombre'] ?? '');
    $categoria['descripcion'] = trim($_POST['descripcion'] ?? '');

    if ($categoria['nombre'] === '') {
        $errores[] = "El nombre es obligatorio.";
    }

    if (empty($errores)) {
        if ($esEdicion) {
            $sql = "UPDATE CategoriasTratamientos
                    SET nombre = :nom, descripcion = :desc
                    WHERE categoria_id = :id";
            $pdo->prepare($sql)->execute([
                ':nom' => $categoria['nombre'],
                ':desc' => $categoria['descripcion'],
                ':id'  => $id
            ]);
            $ok = "Categoría actualizada correctamente.";
        } else {
            $sql = "INSERT INTO CategoriasTratamientos (nombre, descripcion)
                    VALUES (:nom, :desc)";
            $pdo->prepare($sql)->execute([
                ':nom' => $categoria['nombre'],
                ':desc' => $categoria['descripcion']
            ]);
            header("Location: categorias_tratamientos.php?msg=" . urlencode("Categoría creada correctamente."));
            exit;
        }
    }
}
?>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">
    <i class="bi bi-tag me-2"></i>
    <?= $esEdicion ? 'Editar categoría' : 'Nueva categoría' ?>
  </h3>
  <a href="categorias_tratamientos.php" class="btn btn-outline-secondary">
    <i class="bi bi-arrow-left"></i> Volver
  </a>
</div>

<?php if ($errores): ?>
  <div class="alert alert-danger">
    <ul class="mb-0">
      <?php foreach ($errores as $e): ?>
        <li><?= htmlspecialchars($e) ?></li>
      <?php endforeach; ?>
    </ul>
  </div>
<?php endif; ?>

<?php if ($ok): ?>
  <div class="alert alert-success"><?= htmlspecialchars($ok) ?></div>
<?php endif; ?>

<div class="card shadow-sm">
  <div class="card-body">
    <form method="post" class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Nombre *</label>
        <input type="text" name="nombre" class="form-control" required
               value="<?= htmlspecialchars($categoria['nombre']) ?>">
      </div>
      <div class="col-12">
        <label class="form-label">Descripción</label>
        <textarea name="descripcion" rows="3" class="form-control"><?= htmlspecialchars($categoria['descripcion']) ?></textarea>
      </div>
      <div class="col-12 text-end">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-save me-1"></i> Guardar
        </button>
      </div>
    </form>
  </div>
</div>

<?php include 'footer.php'; ?>
