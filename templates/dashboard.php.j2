<?php
require_once 'config.php';
require_once 'auth.php';

require_login();
require_role(['admin','recepcionista']);

$pageTitle = "Dashboard";
include 'header.php';

// ==================
// KPIs RÁPIDOS
// ==================

// Citas hoy
$citasHoyStmt = $pdo->query("
    SELECT COUNT(*) AS total 
    FROM Citas 
    WHERE fecha = CURDATE()
");
$citasHoy = (int)$citasHoyStmt->fetch()['total'];

// Citas realizadas hoy
$realizadasStmt = $pdo->query("
    SELECT COUNT(*) AS total
    FROM Citas 
    WHERE fecha = CURDATE()
      AND estado = 'realizada'
");
$realizadasHoy = (int)$realizadasStmt->fetch()['total'];

// Canceladas hoy
$canceladasStmt = $pdo->query("
    SELECT COUNT(*) AS total
    FROM Citas 
    WHERE fecha = CURDATE()
      AND estado = 'cancelada'
");
$canceladasHoy = (int)$canceladasStmt->fetch()['total'];

// Clientes nuevos este mes
$clientesMesStmt = $pdo->query("
    SELECT COUNT(*) AS total
    FROM Clientes
    WHERE YEAR(fecha_registro) = YEAR(CURDATE())
      AND MONTH(fecha_registro) = MONTH(CURDATE())
");
$clientesNuevosMes = (int)$clientesMesStmt->fetch()['total'];

// Stock crítico
$stockCriticoStmt = $pdo->query("SELECT COUNT(*) AS total FROM vw_stock_critico");
$stockCritico = (int)$stockCriticoStmt->fetch()['total'];

// =======================
// CITAS DEL DÍA
// =======================
$citasStmt = $pdo->query("
    SELECT 
        c.*, 
        cli.nombre AS c_nombre, 
        cli.apellido AS c_apellido,
        emp.nombre AS e_nombre,
        emp.apellido AS e_apellido,
        t.nombre AS t_nombre
    FROM Citas c
    LEFT JOIN Clientes cli ON cli.cliente_id = c.cliente_id
    LEFT JOIN Empleados emp ON emp.empleado_id = c.empleado_id
    LEFT JOIN Tratamientos t ON t.tratamiento_id = c.tratamiento_id
    WHERE c.fecha = CURDATE()
    ORDER BY c.hora ASC
");
$citasHoyLista = $citasStmt->fetchAll();
?>

<h3 class="mb-4"><i class="bi bi-speedometer2 me-2"></i>Panel de Control</h3>

<!-- KPIs -->
<div class="row g-3 mb-4">

  <div class="col-md-3">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body d-flex justify-content-between">
        <div>
          <div class="text-muted small">Citas Hoy</div>
          <div class="h4"><?= $citasHoy ?></div>
        </div>
        <div class="text-primary p-3 bg-primary bg-opacity-10 rounded-circle">
          <i class="bi bi-calendar-day"></i>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body d-flex justify-content-between">
        <div>
          <div class="text-muted small">Realizadas</div>
          <div class="h4 text-success"><?= $realizadasHoy ?></div>
        </div>
        <div class="text-success p-3 bg-success bg-opacity-10 rounded-circle">
          <i class="bi bi-check2-circle"></i>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body d-flex justify-content-between">
        <div>
          <div class="text-muted small">Canceladas</div>
          <div class="h4 text-danger"><?= $canceladasHoy ?></div>
        </div>
        <div class="text-danger p-3 bg-danger bg-opacity-10 rounded-circle">
          <i class="bi bi-x-circle"></i>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body d-flex justify-content-between">
        <div>
          <div class="text-muted small">Clientes nuevos (mes)</div>
          <div class="h4"><?= $clientesNuevosMes ?></div>
        </div>
        <div class="text-info p-3 bg-info bg-opacity-10 rounded-circle">
          <i class="bi bi-person-plus"></i>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- ALERTAS -->
<?php if ($stockCritico > 0): ?>
<div class="alert alert-danger shadow-sm">
  <i class="bi bi-exclamation-triangle-fill me-2"></i>
  Hay <strong><?= $stockCritico ?></strong> productos con stock crítico.  
  <a href="inventario.php" class="alert-link">Revisar inventario</a>
</div>
<?php endif; ?>

<!-- CITAS DE HOY -->
<div class="card shadow-sm mb-5">
  <div class="card-header bg-white border-0">
    <h5 class="mb-0">
      <i class="bi bi-calendar2-week me-2"></i>
      Citas de Hoy
    </h5>
  </div>

  <div class="table-responsive">
    <table class="table table-hover mb-0">
      <thead class="table-light">
        <tr>
          <th>Hora</th>
          <th>Cliente</th>
          <th>Empleado</th>
          <th>Tratamiento</th>
          <th>Estado</th>
          <th class="text-end">Acciones</th>
        </tr>
      </thead>
      <tbody>

      <?php if ($citasHoyLista): ?>
        <?php foreach ($citasHoyLista as $c): ?>
        <tr>
          <td><?= htmlspecialchars($c['hora']) ?></td>
          <td><?= htmlspecialchars($c['c_nombre'].' '.$c['c_apellido']) ?></td>
          <td><?= htmlspecialchars($c['e_nombre'].' '.$c['e_apellido']) ?></td>
          <td><?= htmlspecialchars($c['t_nombre']) ?></td>
          <td>
            <?php if ($c['estado'] === 'pendiente'): ?>
            <span class="badge bg-warning text-dark">Pendiente</span>
            <?php elseif ($c['estado'] === 'realizada'): ?>
            <span class="badge bg-success">Realizada</span>
            <?php else: ?>
            <span class="badge bg-secondary">Cancelada</span>
            <?php endif; ?>
          </td>
          <td class="text-end">
            <a href="cita_detalle.php?id=<?= $c['cita_id'] ?>" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-eye"></i>
            </a>
          </td>
        </tr>
        <?php endforeach; ?>
      <?php else: ?>
        <tr><td colspan="6" class="text-center py-4 text-muted">No hay citas para hoy</td></tr>
      <?php endif; ?>

      </tbody>
    </table>
  </div>
</div>

<?php include 'footer.php'; ?>
