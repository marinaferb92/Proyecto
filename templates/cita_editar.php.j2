<?php
require_once 'config.php';
require_once 'auth.php';

require_login();
require_role(['admin','recepcionista']);

$id = $_GET['id'] ?? null;

// Valores por defecto
$cita = [
    'cliente_id' => '',
    'empleado_id' => '',
    'tratamiento_id' => '',
    'sala_id' => '',
    'fecha_cita' => date('Y-m-d'),
    'hora_cita'  => date('H:i'),
    'estado' => 'pendiente',
    'observaciones' => ''
];

if ($id) {
    $stmt = $pdo->prepare("SELECT * FROM Citas WHERE cita_id = ?");
    $stmt->execute([$id]);
    $cita = $stmt->fetch();
    if (!$cita) die("Cita no encontrada");
}

// Listas para selects
$clientes = $pdo->query("SELECT cliente_id, nombre, apellido FROM Clientes ORDER BY apellido")->fetchAll();
$empleados = $pdo->query("SELECT empleado_id, nombre, apellido FROM Empleados WHERE activo=1 ORDER BY apellido")->fetchAll();
$tratamientos = $pdo->query("SELECT tratamiento_id, nombre FROM Tratamientos ORDER BY nombre")->fetchAll();
$salas = $pdo->query("SELECT sala_id, nombre FROM Salas ORDER BY nombre")->fetchAll();

if ($_SERVER["REQUEST_METHOD"] === "POST") {

    $data = [
        $_POST['cliente_id'],
        $_POST['empleado_id'],
        $_POST['tratamiento_id'],
        $_POST['sala_id'] ?: null,
        $_POST['fecha_cita'],
        $_POST['hora_cita'],
        $_POST['estado'],
        $_POST['observaciones']
    ];

    if ($id) {
        // UPDATE
        $data[] = $id;
        $sql = "UPDATE Citas
                SET cliente_id=?, empleado_id=?, tratamiento_id=?, sala_id=?,
                    fecha_cita=?, hora_cita=?, estado=?, observaciones=?
                WHERE cita_id=?";
        $pdo->prepare($sql)->execute($data);

    } else {
        // INSERT
        $sql = "INSERT INTO Citas 
                (cliente_id, empleado_id, tratamiento_id, sala_id, fecha_cita, hora_cita, estado, observaciones)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)";
        $pdo->prepare($sql)->execute($data);
        $id = $pdo->lastInsertId();
    }

    header("Location: cita_detalle.php?id=$id");
    exit;
}

$pageTitle = $id ? "Editar Cita" : "Nueva Cita";
include 'header.php';
?>

<h3 class="mb-4">
    <i class="bi bi-calendar-event me-2"></i><?= $pageTitle ?>
</h3>

<form method="POST" class="card card-body shadow-sm">

<div class="row mb-3">
  <div class="col-md-6">
    <label class="form-label">Cliente</label>
    <select name="cliente_id" class="form-select" required>
      <option value="">Seleccionar…</option>
      <?php foreach ($clientes as $c): ?>
        <option value="<?= $c['cliente_id'] ?>" 
            <?= $cita['cliente_id']==$c['cliente_id']?'selected':'' ?>>
            <?= htmlspecialchars($c['nombre'].' '.$c['apellido']) ?>
        </option>
      <?php endforeach; ?>
    </select>
  </div>

  <div class="col-md-6">
    <label class="form-label">Empleado</label>
    <select name="empleado_id" class="form-select" required>
      <option value="">Seleccionar…</option>
      <?php foreach ($empleados as $e): ?>
        <option value="<?= $e['empleado_id'] ?>" 
            <?= $cita['empleado_id']==$e['empleado_id']?'selected':'' ?>>
            <?= htmlspecialchars($e['nombre'].' '.$e['apellido']) ?>
        </option>
      <?php endforeach; ?>
    </select>
  </div>
</div>

<div class="row mb-3">
  <div class="col-md-6">
    <label class="form-label">Tratamiento</label>
    <select name="tratamiento_id" class="form-select" required>
      <option value="">Seleccionar…</option>
      <?php foreach ($tratamientos as $t): ?>
        <option value="<?= $t['tratamiento_id'] ?>" 
            <?= $cita['tratamiento_id']==$t['tratamiento_id']?'selected':'' ?>>
            <?= htmlspecialchars($t['nombre']) ?>
        </option>
      <?php endforeach; ?>
    </select>
  </div>

  <div class="col-md-6">
    <label class="form-label">Sala</label>
    <select name="sala_id" class="form-select">
      <option value="">(Sin sala)</option>
      <?php foreach ($salas as $s): ?>
        <option value="<?= $s['sala_id'] ?>" 
            <?= $cita['sala_id']==$s['sala_id']?'selected':'' ?>>
            <?= htmlspecialchars($s['nombre']) ?>
        </option>
      <?php endforeach; ?>
    </select>
  </div>
</div>

<div class="row mb-3">
  <div class="col-md-4">
    <label class="form-label">Fecha</label>
    <input type="date" name="fecha_cita" class="form-control" 
           value="<?= htmlspecialchars($cita['fecha_cita']) ?>" required>
  </div>

  <div class="col-md-4">
    <label class="form-label">Hora</label>
    <input type="time" name="hora_cita" class="form-control" 
           value="<?= htmlspecialchars($cita['hora_cita']) ?>" required>
  </div>

  <div class="col-md-4">
    <label class="form-label">Estado</label>
    <select name="estado" class="form-select">
      <option value="pendiente"  <?= $cita['estado']=='pendiente'?'selected':'' ?>>Pendiente</option>
      <option value="confirmada" <?= $cita['estado']=='confirmada'?'selected':'' ?>>Confirmada</option>
      <option value="realizada"  <?= $cita['estado']=='realizada'?'selected':'' ?>>Realizada</option>
      <option value="cancelada"  <?= $cita['estado']=='cancelada'?'selected':'' ?>>Cancelada</option>
    </select>
  </div>
</div>

<div class="mb-3">
  <label class="form-label">Observaciones</label>
  <textarea name="observaciones" class="form-control"><?= htmlspecialchars($cita['observaciones']) ?></textarea>
</div>

<div class="text-end">
  <a href="citas.php" class="btn btn-outline-secondary">Cancelar</a>
  <button class="btn btn-primary">Guardar</button>
</div>

</form>

<?php include 'footer.php'; ?>
