<?php
// proveedor_editar.php
require_once 'config.php';
require_once 'auth.php';

require_login();
require_role(['admin','recepcionista']);

$id = isset($_GET['id']) ? (int)$_GET['id'] : 0;
$esEdicion = $id > 0;

$pageTitle = $esEdicion ? "Editar proveedor" : "Nuevo proveedor";
include 'header.php';

$proveedor = [
    'nombre' => '',
    'telefono' => '',
    'correo' => '',
    'direccion' => ''
];

if ($esEdicion) {
    $stmt = $pdo->prepare("SELECT * FROM Proveedores WHERE proveedor_id = :id");
    $stmt->execute([':id' => $id]);
    $proveedor = $stmt->fetch();

    if (!$proveedor) {
        echo "<div class='alert alert-danger'>Proveedor no encontrado.</div>";
        include 'footer.php';
        exit;
    }
}

$errores = [];
$ok = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $proveedor['nombre'] = trim($_POST['nombre']);
    $proveedor['telefono'] = trim($_POST['telefono']);
    $proveedor['correo'] = trim($_POST['correo']);
    $proveedor['direccion'] = trim($_POST['direccion']);

    if ($proveedor['nombre'] === '') {
        $errores[] = "El nombre es obligatorio.";
    }

    if (!$errores) {

        if ($esEdicion) {
            $sql = "UPDATE Proveedores SET
                        nombre = :nom,
                        telefono = :tel,
                        correo = :cor,
                        direccion = :dir
                    WHERE proveedor_id = :id";

            $pdo->prepare($sql)->execute([
                ':nom' => $proveedor['nombre'],
                ':tel' => $proveedor['telefono'],
                ':cor' => $proveedor['correo'],
                ':dir' => $proveedor['direccion'],
                ':id' => $id
            ]);

            $ok = "Proveedor actualizado.";
        }

        else {
            $sql = "INSERT INTO Proveedores (nombre, telefono, correo, direccion)
                    VALUES (:nom, :tel, :cor, :dir)";

            $pdo->prepare($sql)->execute([
                ':nom' => $proveedor['nombre'],
                ':tel' => $proveedor['telefono'],
                ':cor' => $proveedor['correo'],
                ':dir' => $proveedor['direccion']
            ]);

            header("Location: proveedores.php?msg=" . urlencode("Proveedor creado."));
            exit;
        }
    }
}
?>

<div class="d-flex justify-content-between mb-3">
    <h3><?= $pageTitle ?></h3>
    <a href="proveedores.php" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Volver
    </a>
</div>

<?php if ($errores): ?>
<div class="alert alert-danger">
    <?php foreach ($errores as $e): ?>
        <div><?= htmlspecialchars($e) ?></div>
    <?php endforeach; ?>
</div>
<?php endif; ?>

<?php if ($ok): ?>
<div class="alert alert-success"><?= htmlspecialchars($ok) ?></div>
<?php endif; ?>

<form method="post" class="card shadow-sm p-3">
    <div class="mb-3">
        <label class="form-label">Nombre *</label>
        <input type="text" name="nombre" class="form-control"
               value="<?= htmlspecialchars($proveedor['nombre']) ?>" required>
    </div>

    <div class="row g-3">
        <div class="col-md-4">
            <label class="form-label">Teléfono</label>
            <input type="text" name="telefono" class="form-control"
                   value="<?= htmlspecialchars($proveedor['telefono']) ?>">
        </div>

        <div class="col-md-8">
            <label class="form-label">Correo</label>
            <input type="email" name="correo" class="form-control"
                   value="<?= htmlspecialchars($proveedor['correo']) ?>">
        </div>
    </div>

    <div class="mt-3">
        <label class="form-label">Dirección</label>
        <textarea name="direccion" rows="3" class="form-control"><?= htmlspecialchars($proveedor['direccion']) ?></textarea>
    </div>

    <div class="text-end mt-3">
        <button class="btn btn-primary">
            <i class="bi bi-save"></i> Guardar
        </button>
    </div>
</form>

<?php include 'footer.php'; ?>
