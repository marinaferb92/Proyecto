<?php
require "auth.php";
require "config.php";
$pageTitle="Citas";
include "header.php";
include "navbar.php";

# --- AÑADIR CITA ---
if (isset($_POST["add"])) {
    $stmt = $pdo->prepare("
        INSERT INTO Citas(cliente_id, empleado_id, tratamiento_id, fecha_cita, hora_cita, estado)
        VALUES (?, ?, ?, ?, ?, 'pendiente')
    ");
    $stmt->execute([
        $_POST["cliente"],
        $_POST["empleado"],
        $_POST["tratamiento"],
        $_POST["fecha"],
        $_POST["hora"]
    ]);
}

# --- BORRAR ---
if (isset($_POST["delete"])) {
    $stmt = $pdo->prepare("DELETE FROM Citas WHERE cita_id = ?");
    $stmt->execute([$_POST["id"]]);
}

# --- EDITAR ---
if (isset($_POST["edit"])) {
    $stmt = $pdo->prepare("
        UPDATE Citas SET cliente_id=?, empleado_id=?, tratamiento_id=?, fecha_cita=?, hora_cita=?, estado=?
        WHERE cita_id=?
    ");
    $stmt->execute([
        $_POST["cliente_edit"],
        $_POST["empleado_edit"],
        $_POST["tratamiento_edit"],
        $_POST["fecha_edit"],
        $_POST["hora_edit"],
        $_POST["estado_edit"],
        $_POST["id"]
    ]);
}

# DATOS
$clientes = $pdo->query("SELECT * FROM Clientes ORDER BY nombre")->fetchAll();
$empleados = $pdo->query("SELECT * FROM Empleados ORDER BY nombre")->fetchAll();
$tratamientos = $pdo->query("SELECT * FROM Tratamientos ORDER BY nombre")->fetchAll();

$citas = $pdo->query("
    SELECT c.*, cli.nombre AS cliente, cli.apellido AS cliente_ap,
           e.nombre AS empleado, e.apellido AS empleado_ap,
           t.nombre AS tratamiento
    FROM Citas c
    JOIN Clientes cli ON cli.cliente_id = c.cliente_id
    JOIN Empleados e ON e.empleado_id = c.empleado_id
    JOIN Tratamientos t ON t.tratamiento_id = c.tratamiento_id
    ORDER BY cita_id DESC
")->fetchAll();

?>

<div class="container mt-4">

<h2>Citas</h2>

<form method="POST" class="card p-3 shadow mb-4">

    <h5>Nueva cita</h5>

    <select name="cliente" class="form-control mb-2">
        <?php foreach($clientes as $c): ?>
            <option value="<?= $c['cliente_id'] ?>"><?= $c["nombre"] ?> <?= $c["apellido"] ?></option>
        <?php endforeach; ?>
    </select>

    <select name="empleado" class="form-control mb-2">
        <?php foreach($empleados as $e): ?>
            <option value="<?= $e['empleado_id'] ?>"><?= $e["nombre"] ?> <?= $e["apellido"] ?></option>
        <?php endforeach; ?>
    </select>

    <select name="tratamiento" class="form-control mb-2">
        <?php foreach($tratamientos as $t): ?>
            <option value="<?= $t['tratamiento_id'] ?>"><?= $t["nombre"] ?></option>
        <?php endforeach; ?>
    </select>

    <input name="fecha" type="date" class="form-control mb-2">
    <input name="hora" type="time" class="form-control mb-3">

    <button name="add" class="btn btn-primary w-100">Guardar</button>
</form>

<table class="table table-bordered shadow bg-white">
    <tr>
        <th>ID</th><th>Cliente</th><th>Empleado</th><th>Tratamiento</th>
        <th>Fecha</th><th>Hora</th><th>Estado</th><th>Acciones</th>
    </tr>

    <?php foreach($citas as $c): ?>
    <tr>
        <td><?= $c["cita_id"] ?></td>
        <td><?= $c["cliente"] ?> <?= $c["cliente_ap"] ?></td>
        <td><?= $c["empleado"] ?> <?= $c["empleado_ap"] ?></td>
        <td><?= $c["tratamiento"] ?></td>
        <td><?= $c["fecha_cita"] ?></td>
        <td><?= $c["hora_cita"] ?></td>
        <td><?= $c["estado"] ?></td>

        <td style="width:200px;">
            <button class="btn btn-warning btn-sm" data-bs-toggle="modal"
                    data-bs-target="#editModal<?= $c['cita_id'] ?>">Editar</button>

            <form method="POST" style="display:inline;">
                <input type="hidden" name="id" value="<?= $c['cita_id'] ?>">
                <button name="delete" class="btn btn-danger btn-sm"
                        onclick="return confirm('¿Eliminar cita?')">Eliminar</button>
            </form>
        </td>
    </tr>

    <!-- Modal edición -->
    <div class="modal fade" id="editModal<?= $c['cita_id'] ?>">
      <div class="modal-dialog">
        <div class="modal-content p-3">
            <form method="POST">
                <input type="hidden" name="id" value="<?= $c['cita_id'] ?>">

                <h5>Editar cita</h5>

                <select name="cliente_edit" class="form-control mb-2">
                    <?php foreach($clientes as $cli): ?>
                        <option value="<?= $cli['cliente_id'] ?>"
                            <?= $cli['cliente_id']==$c["cliente_id"]?"selected":"" ?>>
                            <?= $cli["nombre"] ?> <?= $cli["apellido"] ?>
                        </option>
                    <?php endforeach; ?>
                </select>

                <select name="empleado_edit" class="form-control mb-2">
                    <?php foreach($empleados as $e): ?>
                        <option value="<?= $e['empleado_id'] ?>"
                            <?= $e['empleado_id']==$c["empleado_id"]?"selected":"" ?>>
                            <?= $e["nombre"] ?> <?= $e["apellido"] ?>
                        </option>
                    <?php endforeach; ?>
                </select>

                <select name="tratamiento_edit" class="form-control mb-2">
                    <?php foreach($tratamientos as $t): ?>
                        <option value="<?= $t['tratamiento_id'] ?>"
                            <?= $t['tratamiento_id']==$c["tratamiento_id"]?"selected":"" ?>>
                            <?= $t["nombre"] ?>
                        </option>
                    <?php endforeach; ?>
                </select>

                <input name="fecha_edit" type="date" value="<?= $c['fecha_cita'] ?>" class="form-control mb-2">
                <input name="hora_edit" type="time" value="<?= $c['hora_cita'] ?>" class="form-control mb-2">

                <select name="estado_edit" class="form-control mb-3">
                    <option <?= $c['estado']=='pendiente'?'selected':'' ?> value="pendiente">Pendiente</option>
                    <option <?= $c['estado']=='confirmada'?'selected':'' ?> value="confirmada">Confirmada</option>
                    <option <?= $c['estado']=='realizada'?'selected':'' ?> value="realizada">Realizada</option>
                    <option <?= $c['estado']=='cancelada'?'selected':'' ?> value="cancelada">Cancelada</option>
                </select>

                <button name="edit" class="btn btn-success w-100">Guardar cambios</button>
            </form>
        </div>
      </div>
    </div>

    <?php endforeach; ?>
</table>

</div>

<?php include "footer.php"; ?>
