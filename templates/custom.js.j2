// ==============================
// TOGGLE DARK MODE
// ==============================
document.addEventListener("DOMContentLoaded", () => {
    const toggle = document.getElementById("dark-mode-toggle");

    if (toggle) {
        toggle.addEventListener("click", () => {
            document.body.classList.toggle("dark-mode");
            localStorage.setItem("darkMode", document.body.classList.contains("dark-mode"));
        });

        if (localStorage.getItem("darkMode") === "true") {
            document.body.classList.add("dark-mode");
        }
    }
});

// ==============================
// AUTOCOMPLETE CLIENTES
// ==============================

document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("buscador-clientes");
    const box   = document.getElementById("cliente-resultados");

    if (!input || !box) return;

    let timeout = null;

    function render(data) {
        if (data.length === 0) {
            box.innerHTML = `<div class="autocomplete-item text-muted">Sin resultados</div>`;
            box.style.display = "block";
            return;
        }

        box.innerHTML = data.map(c => `
            <div class="autocomplete-item" data-id="${c.cliente_id}">
                <strong>${c.nombre} ${c.apellido}</strong><br>
                <small class="text-muted">${c.dni} Â· ${c.telefono}</small>
            </div>
        `).join("");

        box.style.display = "block";
    }

    box.addEventListener("click", e => {
        const item = e.target.closest(".autocomplete-item");
        if (item) window.location.href = "cliente_detalle.php?id=" + item.dataset.id;
    });

    input.addEventListener("input", () => {
        const q = input.value.trim();
        clearTimeout(timeout);

        if (q.length < 2) {
            box.style.display = "none";
            return;
        }

        timeout = setTimeout(() => {
            fetch("buscar_clientes.php?q=" + encodeURIComponent(q))
                .then(r => r.json())
                .then(render);
        }, 200);
    });
});

// ==============================
// AUTOCOMPLETE INVENTARIO
// ==============================

document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("inventario-search");
    const box   = document.getElementById("inventario-resultados");

    if (!input || !box) return;

    let timeout = null;

    function renderInv(data) {
        if (data.length === 0) {
            box.innerHTML = `<div class="autocomplete-item text-muted">Sin resultados</div>`;
            box.style.display = "block";
            return;
        }

        box.innerHTML = data.map(item => `
            <div class="autocomplete-item" data-id="${item.item_id}">
                <strong>${item.nombre}</strong><br>
                <small class="text-muted">${item.tipo}</small><br>
                ${item.stock_actual < 10
                    ? `<span class="badge bg-danger">Stock bajo (${item.stock_actual})</span>`
                    : `<span class="badge bg-success">${item.stock_actual} en stock</span>`}
            </div>
        `).join("");

        box.style.display = "block";
    }

    box.addEventListener("click", e => {
        const item = e.target.closest(".autocomplete-item");
        if (item) window.location.href = "inventario_editar.php?id=" + item.dataset.id;
    });

    input.addEventListener("input", () => {
        const q = input.value.trim();
        clearTimeout(timeout);

        if (q.length < 1) {
            box.style.display = "none";
            return;
        }

        timeout = setTimeout(() => {
            fetch("buscar_inventario.php?q=" + encodeURIComponent(q))
                .then(r => r.json())
                .then(renderInv);
        }, 200);
    });
});

// ==============================
// CERRAR AUTOCOMPLETE AL HACER CLICK FUERA
// ==============================

document.addEventListener("click", e => {
    const boxes = document.querySelectorAll(".autocomplete-results");

    boxes.forEach(box => {
        if (!box.contains(e.target) && e.target.tagName !== "INPUT") {
            box.style.display = "none";
        }
    });
});
