<?php
require_once 'config.php';
require_once 'includes/auth.php';

require_login();
require_role(['admin','recepcionista']);

$pageTitle = "Inventario";
include 'includes/header.php';

// Alta
if ($_SERVER['REQUEST_METHOD'] === 'POST' && $_POST['accion'] === 'nuevo') {

    $stmt = $pdo->prepare("
        INSERT INTO Inventario(nombre, tipo, stock_actual, unidad, costo_unitario, proveedor_id)
        VALUES (:n,:t,:s,:u,:c,:p)
    ");

    $stmt->execute([
        ':n' => $_POST['nombre'],
        ':t' => $_POST['tipo'],
        ':s' => $_POST['stock_actual'] ?? 0,
        ':u' => $_POST['unidad'],
        ':c' => $_POST['costo_unitario'],
        ':p' => $_POST['proveedor_id'] ?: null
    ]);

    echo "<div class='alert alert-success'>Producto a√±adido.</div>";
}

// Restar stock
if ($_SERVER['REQUEST_METHOD'] === 'POST' && $_POST['accion'] === 'restar') {
    $stmt = $pdo->prepare("
        UPDATE Inventario SET stock_actual = stock_actual - :c WHERE item_id = :id
    ");
    $stmt->execute([
        ':c' => $_POST['cantidad'],
        ':id' => $_POST['item_id']
    ]);
}

$proveedores = $pdo->query("SELECT * FROM Proveedores ORDER BY nombre")->fetchAll();
$items = $pdo->query("SELECT * FROM Inventario ORDER BY nombre")->fetchAll();
?>

<div class="container mt-4">
    <h3>Inventario</h3>

    <div class="row">

        <!-- Form -->
        <div class="col-md-5">
            <div class="card shadow-sm">
                <div class="card-body">

                    <form method="post">
                        <input type="hidden" name="accion" value="nuevo">

                        <label>Nombre *</label>
                        <input type="text" name="nombre" class="form-control mb-2" required>

                        <label>Tipo</label>
                        <select name="tipo" class="form-control mb-2">
                            <option value="insumo">Insumo</option>
                            <option value="producto">Producto</option>
                            <option value="equipamiento">Equipamiento</option>
                        </select>

                        <label>Stock inicial</label>
                        <input type="number" name="stock_actual" class="form-control mb-2" value="0">

                        <label>Unidad</label>
                        <input type="text" name="unidad" class="form-control mb-2" value="unid">

                        <label>Costo unitario</label>
                        <input type="number" name="costo_unitario" step="0.01" class="form-control mb-2" value="0">

                        <label>Proveedor</label>
                        <select name="proveedor_id" class="form-control mb-3">
                            <option value="">Sin proveedor</option>
                            <?php foreach($proveedores as $p): ?>
                                <option value="<?= $p['proveedor_id'] ?>"><?= $p['nombre'] ?></option>
                            <?php endforeach ?>
                        </select>

                        <button class="btn btn-primary w-100">Guardar</button>
                    </form>

                </div>
            </div>
        </div>

        <!-- Tabla -->
        <div class="col-md-7">
            <div class="card shadow-sm">
                <div class="card-body">

                    <table class="table table-striped table-sm align-middle">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Tipo</th>
                                <th>Stock</th>
                                <th>Unidad</th>
                                <th>Restar</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach($items as $i): ?>
                            <tr>
                                <td><?= $i['nombre'] ?></td>
                                <td><?= $i['tipo'] ?></td>
                                <td><?= $i['stock_actual'] ?></td>
                                <td><?= $i['unidad'] ?></td>
                                <td>
                                    <form method="post" class="d-flex">
                                        <input type="hidden" name="accion" value="restar">
                                        <input type="hidden" name="item_id" value="<?= $i['item_id'] ?>">
                                        <input type="number" name="cantidad" class="form-control form-control-sm me-1" style="width: 80px">
                                        <button class="btn btn-sm btn-danger">OK</button>
                                    </form>
                                </td>
                            </tr>
                            <?php endforeach ?>
                        </tbody>
                    </table>

                </div>
            </div>
        </div>

    </div>
</div>

<?php include 'includes/footer.php'; ?>
