<?php
require_once 'config.php';
require_once 'auth.php';

require_login();
require_role(['admin']);

$id = $_GET['id'] ?? null;

$item = [
  'nombre' => '',
  'tipo' => 'insumo',
  'stock_actual' => 0,
  'unidad' => '',
  'costo_unitario' => '',
  'proveedor_id' => null
];

if ($id) {
    $stmt = $pdo->prepare("SELECT * FROM Inventario WHERE item_id = ?");
    $stmt->execute([$id]);
    $item = $stmt->fetch();

    if (!$item) die("Ítem no encontrado");
}

$proveedores = $pdo->query("SELECT proveedor_id, nombre FROM Proveedores ORDER BY nombre")->fetchAll();

if ($_SERVER["REQUEST_METHOD"] === "POST") {

    $data = [
        $_POST['nombre'],
        $_POST['tipo'],
        $_POST['stock_actual'],
        $_POST['unidad'],
        $_POST['costo_unitario'],
        $_POST['proveedor_id'] ?: null
    ];

    if ($id) {
        $data[] = $id;
        $sql = "UPDATE Inventario
                SET nombre=?, tipo=?, stock_actual=?, unidad=?, 
                    costo_unitario=?, proveedor_id=?
                WHERE item_id=?";
        $pdo->prepare($sql)->execute($data);

    } else {
        $sql = "INSERT INTO Inventario 
                (nombre, tipo, stock_actual, unidad, costo_unitario, proveedor_id)
                VALUES (?, ?, ?, ?, ?, ?)";
        $pdo->prepare($sql)->execute($data);
    }

    header("Location: inventario.php");
    exit;
}

$pageTitle = $id ? "Editar Ítem" : "Nuevo Ítem";
include 'header.php';
?>

<h3 class="mb-4"><i class="bi bi-box2-heart me-2"></i><?= $pageTitle ?></h3>

<form method="POST" class="card card-body shadow-sm">

  <div class="mb-3">
    <label class="form-label">Nombre</label>
    <input name="nombre" class="form-control" required value="<?= htmlspecialchars($item['nombre']) ?>">
  </div>

  <div class="row mb-3">
    <div class="col-md-4">
      <label class="form-label">Tipo</label>
      <select name="tipo" class="form-select">
        <option value="insumo" <?= $item['tipo']=='insumo'?'selected':'' ?>>Insumo</option>
        <option value="producto" <?= $item['tipo']=='producto'?'selected':'' ?>>Producto</option>
        <option value="equipamiento" <?= $item['tipo']=='equipamiento'?'selected':'' ?>>Equipamiento</option>
      </select>
    </div>

    <div class="col-md-4">
      <label class="form-label">Stock actual</label>
      <input name="stock_actual" type="number" class="form-control"
             value="<?= htmlspecialchars($item['stock_actual']) ?>">
    </div>

    <div class="col-md-4">
      <label class="form-label">Unidad</label>
      <input name="unidad" class="form-control" value="<?= htmlspecialchars($item['unidad']) ?>">
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-4">
      <label class="form-label">Costo Unitario (€)</label>
      <input name="costo_unitario" type="number" step="0.01"
             class="form-control"
             value="<?= htmlspecialchars($item['costo_unitario']) ?>">
    </div>

    <div class="col-md-8">
      <label class="form-label">Proveedor</label>
      <select name="proveedor_id" class="form-select">
        <option value="">Sin proveedor</option>
        <?php foreach ($proveedores as $p): ?>
          <option value="<?= $p['proveedor_id'] ?>" <?= $item['proveedor_id']==$p['proveedor_id']?'selected':'' ?>>
            <?= htmlspecialchars($p['nombre']) ?>
          </option>
        <?php endforeach; ?>
      </select>
    </div>
  </div>

  <div class="text-end">
    <a href="inventario.php" class="btn btn-outline-secondary">Cancelar</a>
    <button class="btn btn-primary">Guardar</button>
  </div>

</form>

<?php include 'footer.php'; ?>
